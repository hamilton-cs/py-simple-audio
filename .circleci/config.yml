version: 2.1

jobs:
  # --- Build Wheels: Linux ---
  build-wheels-linux:
    docker:
      - image: cimg/python:3.12
    resource_class: medium
    environment:
      # Build for Python 3.10, 3.11, 3.12 (CPython)
      CIBW_BUILD: "cp310-* cp311-* cp312-*"
      # Skip 32-bit builds (optional, usually safe to skip nowadays)
      CIBW_SKIP: "*-manylinux_i686"
      # IMPORTANT: Install ALSA dev headers inside the manylinux container before building
      # manylinux2014 uses yum (CentOS based)
      CIBW_BEFORE_ALL_LINUX: "sudo apt-get install -y libasound2-dev"
      # Run your unit tests against the installed wheel
      CIBW_TEST_COMMAND: "python -m unittest discover -s {project}/tests" 
    steps:
      - checkout
      - setup_remote_docker:
          version: default
      
      - run:
          name: Install cibuildwheel
          command: pip install cibuildwheel

      - run:
          name: Build Wheels
          command: cibuildwheel --output-dir dist

      # Build the source distribution (tar.gz) on Linux only
      - run:
          name: Build Source Distribution
          command: python setup.py sdist --dist-dir dist

      - store_artifacts:
          path: dist

      - persist_to_workspace:
          root: .
          paths:
            - dist

  # --- Build Wheels: macOS ---
  build-wheels-macos:
    macos:
      xcode: 26.0 # Newer Xcode for better compatibility
    resource_class: macos.m1.medium.gen1
    environment:
      CIBW_BUILD: "cp310-* cp311-* cp312-*"
      CIBW_ARCHS_MACOS: "arm64" # Build for Intel and Apple Silicon
      CIBW_TEST_COMMAND: "python -m unittest discover -s {project}/tests"
    steps:
      - checkout
      
      - run:
          name: Install cibuildwheel
          command: pip3 install cibuildwheel

      - run:
          name: Build Wheels
          command: cibuildwheel --output-dir dist

      - store_artifacts:
          path: dist

      - persist_to_workspace:
          root: .
          paths:
            - dist

  # --- Build Wheels: Windows ---
  build-wheels-windows:
    machine:
      image: windows-server-2022-gui:current
    resource_class: windows.medium
    shell: powershell.exe
    environment:
      CIBW_BUILD: "cp310-* cp311-* cp312-*"
      CIBW_ARCHS_WINDOWS: "AMD64"
      CIBW_TEST_COMMAND: "python -m unittest discover -s {project}/tests"
    steps:
      - checkout

      - run:
          name: Install Python & cibuildwheel
          command: |
            choco install python --version=3.11.0 -y
            refreshenv
            pip install cibuildwheel

      - run:
          name: Build Wheels
          command: cibuildwheel --output-dir dist

      - store_artifacts:
          path: dist

      - persist_to_workspace:
          root: .
          paths:
            - dist

  # --- Deploy All Artifacts ---
  deploy-to-pypi:
    docker:
      - image: cimg/python:3.12
    steps:
      - attach_workspace:
          at: .

      - run:
          name: Install Twine
          command: pip install twine

      - run:
          name: Check Dist Files
          command: ls -l dist/

      - run:
          name: Upload to PyPI
          command: |
            twine upload --verbose dist/* \
              -u "${PYPI_USERNAME}" \
              -p "${PYPI_PASSWORD}"

workflows:
  version: 2
  build-and-publish:
    jobs:
      - build-wheels-linux
      - build-wheels-macos
      - build-wheels-windows
      - deploy-to-pypi:
          requires:
            - build-wheels-linux
            - build-wheels-macos
            - build-wheels-windows
          filters:
            branches:
              only: master